name: ğŸ§ª Script Validation

on:
  pull_request:
    paths:
      - 'scripts/**'
      - 'tools/**'
  push:
    branches: [ main ]
    paths:
      - 'scripts/**'
      - 'tools/**'

jobs:
  detect-changes:
    name: ğŸ” æ£€æµ‹è„šæœ¬å˜æ›´
    runs-on: ubuntu-latest
    outputs:
      scripts: ${{ steps.changes.outputs.scripts }}
      scripts_files: ${{ steps.changes.outputs.scripts_files }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: æ£€æµ‹å˜æ›´çš„è„šæœ¬
        id: changes
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            base_sha="${{ github.event.pull_request.base.sha }}"
            head_sha="${{ github.event.pull_request.head.sha }}"
          else
            base_sha="${{ github.event.before }}"
            head_sha="${{ github.sha }}"
          fi
          
          # è·å–å˜æ›´çš„è„šæœ¬æ–‡ä»¶
          changed_files=$(git diff --name-only $base_sha..$head_sha | grep '^scripts/.*\.sh$' || true)
          
          if [ -n "$changed_files" ]; then
            echo "scripts=true" >> $GITHUB_OUTPUT
            echo "scripts_files<<EOF" >> $GITHUB_OUTPUT
            echo "$changed_files" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            
            echo "æ£€æµ‹åˆ°å˜æ›´çš„è„šæœ¬æ–‡ä»¶:"
            echo "$changed_files"
          else
            echo "scripts=false" >> $GITHUB_OUTPUT
            echo "æ²¡æœ‰æ£€æµ‹åˆ°è„šæœ¬æ–‡ä»¶å˜æ›´"
          fi

  syntax-check:
    name: ğŸ“ è¯­æ³•æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: å®‰è£… shellcheck
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
      
      - name: è¯­æ³•æ£€æŸ¥
        run: |
          echo "${{ needs.detect-changes.outputs.scripts_files }}" | while read -r script; do
            if [ -n "$script" ] && [ -f "$script" ]; then
              echo "ğŸ” æ£€æŸ¥è„šæœ¬: $script"
              
              # Bash è¯­æ³•æ£€æŸ¥
              echo "  ğŸ“ Bash è¯­æ³•æ£€æŸ¥..."
              if ! bash -n "$script"; then
                echo "âŒ è¯­æ³•é”™è¯¯: $script"
                exit 1
              fi
              
              # Shellcheck æ£€æŸ¥
              echo "  ğŸ”§ Shellcheck æ£€æŸ¥..."
              if ! shellcheck -x "$script"; then
                echo "âš ï¸  Shellcheck å‘ç°é—®é¢˜: $script"
                # ä¸å›  shellcheck è­¦å‘Šè€Œå¤±è´¥ï¼Œä½†ä¼šæ˜¾ç¤º
              fi
              
              echo "âœ… $script æ£€æŸ¥é€šè¿‡"
            fi
          done

  structure-validation:
    name: ğŸ“ ç»“æ„éªŒè¯
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: éªŒè¯è„šæœ¬ç»“æ„
        run: |
          echo "${{ needs.detect-changes.outputs.scripts_files }}" | while read -r script; do
            if [ -n "$script" ] && [ -f "$script" ]; then
              echo "ğŸ” éªŒè¯è„šæœ¬ç»“æ„: $script"
              
              # æ£€æŸ¥å¿…éœ€çš„å…ƒç´ 
              required_elements=(
                "#!/bin/bash"
                "set -euo pipefail"
                "log()"
                "main()"
                "--help"
              )
              
              missing_elements=()
              for element in "${required_elements[@]}"; do
                if ! grep -q "$element" "$script"; then
                  missing_elements+=("$element")
                fi
              done
              
              if [ ${#missing_elements[@]} -gt 0 ]; then
                echo "âš ï¸  è„šæœ¬ $script ç¼ºå°‘æ¨èå…ƒç´ :"
                printf '   â€¢ %s\n' "${missing_elements[@]}"
              else
                echo "âœ… $script ç»“æ„å®Œæ•´"
              fi
            fi
          done



  config-validation:
    name: âš™ï¸  é…ç½®éªŒè¯
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: å®‰è£… yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: éªŒè¯é…ç½®æ–‡ä»¶
        run: |
          if [ -f "scripts/config.yaml" ]; then
            echo "ğŸ” éªŒè¯é…ç½®æ–‡ä»¶æ ¼å¼..."
            
            # YAML æ ¼å¼æ£€æŸ¥
            if yq eval '.' scripts/config.yaml >/dev/null; then
              echo "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®"
            else
              echo "âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
              exit 1
            fi
            
            # æ£€æŸ¥æ–°è„šæœ¬æ˜¯å¦åœ¨é…ç½®ä¸­
            echo "${{ needs.detect-changes.outputs.scripts_files }}" | while read -r script; do
              if [ -n "$script" ] && [ -f "$script" ]; then
                script_name=$(basename "$script" .sh)
                script_dir=$(basename $(dirname "$script"))
                
                if [ "$script_dir" = "install" ]; then
                  echo "ğŸ” æ£€æŸ¥è„šæœ¬ $script_name æ˜¯å¦åœ¨é…ç½®ä¸­..."
                  
                  # è¿™é‡Œå¯ä»¥æ·»åŠ æ›´å¤æ‚çš„é…ç½®éªŒè¯é€»è¾‘
                  # ä¾‹å¦‚æ£€æŸ¥è„šæœ¬æ˜¯å¦åœ¨ config.yaml ä¸­æœ‰å¯¹åº”é…ç½®
                  
                  echo "â„¹ï¸  è¯·ç¡®ä¿åœ¨ scripts/config.yaml ä¸­æ·»åŠ äº† $script_name çš„é…ç½®"
                fi
              fi
            done
          else
            echo "âš ï¸  é…ç½®æ–‡ä»¶ scripts/config.yaml ä¸å­˜åœ¨"
          fi

  security-scan:
    name: ğŸ”’ å®‰å…¨æ‰«æ
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: å®‰å…¨æ‰«æ
        run: |
          echo "${{ needs.detect-changes.outputs.scripts_files }}" | while read -r script; do
            if [ -n "$script" ] && [ -f "$script" ]; then
              echo "ğŸ”’ å®‰å…¨æ‰«æ: $script"
              
              # æ£€æŸ¥å±é™©å‘½ä»¤
              dangerous_patterns=(
                "rm -rf /"
                "chmod 777"
                "curl.*|.*sh"
                "wget.*|.*sh"
                "eval.*\$"
                "\$\(.*\)"
              )
              
              security_issues=()
              for pattern in "${dangerous_patterns[@]}"; do
                if grep -E "$pattern" "$script" >/dev/null; then
                  security_issues+=("æ£€æµ‹åˆ°æ½œåœ¨å±é™©æ¨¡å¼: $pattern")
                fi
              done
              
              if [ ${#security_issues[@]} -gt 0 ]; then
                echo "âš ï¸  å®‰å…¨è­¦å‘Š $script:"
                printf '   â€¢ %s\n' "${security_issues[@]}"
                echo "è¯·ä»”ç»†æ£€æŸ¥è¿™äº›æ¨¡å¼æ˜¯å¦å®‰å…¨"
              else
                echo "âœ… $script å®‰å…¨æ‰«æé€šè¿‡"
              fi
            fi
          done

  documentation-check:
    name: ğŸ“š æ–‡æ¡£æ£€æŸ¥
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.scripts == 'true'
    steps:
      - uses: actions/checkout@v4
      
      - name: æ£€æŸ¥æ–‡æ¡£å®Œæ•´æ€§
        run: |
          echo "${{ needs.detect-changes.outputs.scripts_files }}" | while read -r script; do
            if [ -n "$script" ] && [ -f "$script" ]; then
              echo "ğŸ“š æ£€æŸ¥æ–‡æ¡£: $script"
              
              # æ£€æŸ¥è„šæœ¬å¤´éƒ¨ä¿¡æ¯
              required_headers=(
                "# ç‰ˆæœ¬:"
                "# ä½œè€…:"
                "# æè¿°:"
                "# æ”¯æŒç³»ç»Ÿ:"
              )
              
              missing_headers=()
              for header in "${required_headers[@]}"; do
                if ! head -20 "$script" | grep -q "$header"; then
                  missing_headers+=("$header")
                fi
              done
              
              if [ ${#missing_headers[@]} -gt 0 ]; then
                echo "âš ï¸  è„šæœ¬ $script ç¼ºå°‘æ–‡æ¡£ä¿¡æ¯:"
                printf '   â€¢ %s\n' "${missing_headers[@]}"
              else
                echo "âœ… $script æ–‡æ¡£å®Œæ•´"
              fi
            fi
          done

  pr-comment:
    name: ğŸ’¬ PR è¯„è®º
    runs-on: ubuntu-latest
    needs: [syntax-check, structure-validation, config-validation, security-scan, documentation-check]
    if: github.event_name == 'pull_request' && needs.detect-changes.outputs.scripts == 'true'
    steps:
      - name: åˆ›å»º PR è¯„è®º
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo, number } = context.issue;
            
            const comment = `## ğŸ§ª è„šæœ¬éªŒè¯ç»“æœ
            
            æ‚¨çš„è„šæœ¬æäº¤å·²é€šè¿‡è‡ªåŠ¨åŒ–éªŒè¯ï¼
            
            ### âœ… å®Œæˆçš„æ£€æŸ¥
            - ğŸ“ è¯­æ³•æ£€æŸ¥
            - ğŸ“ ç»“æ„éªŒè¯  
            - âš™ï¸  é…ç½®éªŒè¯
            - ğŸ”’ å®‰å…¨æ‰«æ
            - ğŸ“š æ–‡æ¡£æ£€æŸ¥
            
            ### ğŸ“‹ ä¸‹ä¸€æ­¥
            1. è¯·ç¡®ä¿åœ¨ \`scripts/config.yaml\` ä¸­æ·»åŠ äº†æ–°è„šæœ¬çš„é…ç½®
            2. è€ƒè™‘æ·»åŠ è„šæœ¬çš„ä½¿ç”¨ç¤ºä¾‹å’Œè¯´æ˜
            3. å¦‚æœ‰å®‰å…¨è­¦å‘Šï¼Œè¯·ä»”ç»†æ£€æŸ¥å¹¶ç¡®è®¤å®‰å…¨æ€§
            
            ### ğŸ‰ è´¡çŒ®æ„Ÿè°¢
            æ„Ÿè°¢æ‚¨ä¸º Oneinstack Panel é¡¹ç›®è´¡çŒ®è„šæœ¬ï¼æ‚¨çš„è´¡çŒ®è®©é¡¹ç›®å˜å¾—æ›´å¼ºå¤§ã€‚
            
            ---
            *æ­¤è¯„è®ºç”±è‡ªåŠ¨åŒ–å·¥ä½œæµç”Ÿæˆ*`;
            
            github.rest.issues.createComment({
              owner,
              repo,
              issue_number: number,
              body: comment
            });

  summary:
    name: ğŸ“Š éªŒè¯æ€»ç»“
    runs-on: ubuntu-latest
    needs: [syntax-check, structure-validation, config-validation, security-scan, documentation-check]
    if: always() && needs.detect-changes.outputs.scripts == 'true'
    steps:
      - name: éªŒè¯æ€»ç»“
        run: |
          echo "## ğŸ§ª è„šæœ¬éªŒè¯æ€»ç»“"
          echo ""
          echo "| æ£€æŸ¥é¡¹ | çŠ¶æ€ |"
          echo "|--------|------|"
          echo "| è¯­æ³•æ£€æŸ¥ | ${{ needs.syntax-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
          echo "| ç»“æ„éªŒè¯ | ${{ needs.structure-validation.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
          echo "| é…ç½®éªŒè¯ | ${{ needs.config-validation.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
          echo "| å®‰å…¨æ‰«æ | ${{ needs.security-scan.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
          echo "| æ–‡æ¡£æ£€æŸ¥ | ${{ needs.documentation-check.result == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |"
          
          if [[ "${{ needs.syntax-check.result }}" == "success" && 
                "${{ needs.structure-validation.result }}" == "success" ]]; then
            echo ""
            echo "ğŸ‰ æ‰€æœ‰å…³é”®æ£€æŸ¥é€šè¿‡ï¼è„šæœ¬è´¨é‡è‰¯å¥½ã€‚"
            exit 0
          else
            echo ""
            echo "âŒ éƒ¨åˆ†æ£€æŸ¥å¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦ç»†æ—¥å¿—è¿›è¡Œä¿®å¤ã€‚"
            exit 1
          fi
