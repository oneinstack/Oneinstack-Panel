# Oneinstack Panel è„šæœ¬ç®¡ç† Makefile

.PHONY: help generate test test-all lint clean validate install-tools

# é»˜è®¤ç›®æ ‡
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "Oneinstack Panel è„šæœ¬ç®¡ç†å·¥å…·"
	@echo ""
	@echo "å¯ç”¨å‘½ä»¤:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}'
	@echo ""
	@echo "ç¤ºä¾‹:"
	@echo "  make generate NAME=postgresql TYPE=install"
	@echo "  make test SCRIPT=nginx"
	@echo "  make test-all"
	@echo "  make lint SCRIPT=mysql55"

generate: ## ç”Ÿæˆæ–°è„šæœ¬ (éœ€è¦ NAME å’Œ TYPE å‚æ•°)
	@if [ -z "$(NAME)" ]; then \
		echo "âŒ é”™è¯¯: è¯·æŒ‡å®šè„šæœ¬åç§°"; \
		echo "ç”¨æ³•: make generate NAME=postgresql TYPE=install"; \
		exit 1; \
	fi
	@if [ -z "$(TYPE)" ]; then \
		echo "âŒ é”™è¯¯: è¯·æŒ‡å®šè„šæœ¬ç±»å‹"; \
		echo "ç”¨æ³•: make generate NAME=postgresql TYPE=install"; \
		exit 1; \
	fi
	@echo "ğŸš€ ç”Ÿæˆè„šæœ¬: $(NAME) ($(TYPE))"
	@cd .. && go run cmd/script-generator/main.go --name=$(NAME) --type=$(TYPE) $(if $(AUTHOR),--author="$(AUTHOR)") $(if $(EMAIL),--email="$(EMAIL)") $(if $(VERSION),--version="$(VERSION)") $(if $(PORT),--port="$(PORT)") $(if $(DESC),--desc="$(DESC)") $(if $(CATEGORY),--category="$(CATEGORY)") $(if $(INTERACTIVE),-i)

generate-interactive: ## äº¤äº’å¼ç”Ÿæˆè„šæœ¬
	@echo "ğŸ¯ äº¤äº’å¼è„šæœ¬ç”Ÿæˆ"
	@cd .. && go run cmd/script-generator/main.go -i --name="" --type=install

test: ## æµ‹è¯•æŒ‡å®šè„šæœ¬ (éœ€è¦ SCRIPT å‚æ•°)
	@if [ -z "$(SCRIPT)" ]; then \
		echo "âŒ é”™è¯¯: è¯·æŒ‡å®šè¦æµ‹è¯•çš„è„šæœ¬"; \
		echo "ç”¨æ³•: make test SCRIPT=nginx"; \
		exit 1; \
	fi
	@echo "ğŸ§ª æµ‹è¯•è„šæœ¬: $(SCRIPT)"
	@cd .. && go run cmd/script-tester/main.go --script=$(SCRIPT) $(if $(TYPE),--type=$(TYPE)) $(if $(DRY_RUN),--dry-run) $(if $(VERBOSE),-v) $(if $(OS),--os="$(OS)")

test-all: ## æµ‹è¯•æ‰€æœ‰è„šæœ¬
	@echo "ğŸ§ª æµ‹è¯•æ‰€æœ‰å®‰è£…è„šæœ¬"
	@for script in install/*.sh; do \
		if [ -f "$$script" ]; then \
			name=$$(basename "$$script" .sh); \
			echo ""; \
			echo "ğŸ“ æµ‹è¯•è„šæœ¬: $$name"; \
			echo "----------------------------------------"; \
			cd .. && go run cmd/script-tester/main.go --script=$$name --type=install --dry-run || true; \
		fi \
	done



lint: ## æ£€æŸ¥è„šæœ¬ä»£ç è´¨é‡ (éœ€è¦ SCRIPT å‚æ•°)
	@if [ -z "$(SCRIPT)" ]; then \
		echo "âŒ é”™è¯¯: è¯·æŒ‡å®šè¦æ£€æŸ¥çš„è„šæœ¬"; \
		echo "ç”¨æ³•: make lint SCRIPT=nginx"; \
		exit 1; \
	fi
	@echo "ğŸ” æ£€æŸ¥è„šæœ¬: $(SCRIPT)"
	@script_path="$(TYPE)/$(SCRIPT).sh"; \
	if [ ! -f "$$script_path" ]; then \
		script_path="install/$(SCRIPT).sh"; \
	fi; \
	if [ -f "$$script_path" ]; then \
		echo "ğŸ“ è¯­æ³•æ£€æŸ¥..."; \
		bash -n "$$script_path" && echo "âœ… è¯­æ³•æ­£ç¡®" || echo "âŒ è¯­æ³•é”™è¯¯"; \
		if command -v shellcheck >/dev/null 2>&1; then \
			echo "ğŸ”§ Shellcheck æ£€æŸ¥..."; \
			shellcheck -x "$$script_path" || echo "âš ï¸  å‘ç°ä»£ç è´¨é‡é—®é¢˜"; \
		else \
			echo "âš ï¸  Shellcheck æœªå®‰è£…ï¼Œè·³è¿‡ä»£ç è´¨é‡æ£€æŸ¥"; \
		fi; \
	else \
		echo "âŒ è„šæœ¬æ–‡ä»¶ä¸å­˜åœ¨: $$script_path"; \
	fi

lint-all: ## æ£€æŸ¥æ‰€æœ‰è„šæœ¬çš„ä»£ç è´¨é‡
	@echo "ğŸ” æ£€æŸ¥æ‰€æœ‰è„šæœ¬"
	@for dir in install uninstall config; do \
		if [ -d "$$dir" ]; then \
			echo ""; \
			echo "ğŸ“ æ£€æŸ¥ $$dir ç›®å½•"; \
			echo "----------------------------------------"; \
			for script in $$dir/*.sh; do \
				if [ -f "$$script" ]; then \
					echo "ğŸ” $$script"; \
					bash -n "$$script" && echo "  âœ… è¯­æ³•æ­£ç¡®" || echo "  âŒ è¯­æ³•é”™è¯¯"; \
					if command -v shellcheck >/dev/null 2>&1; then \
						shellcheck -x "$$script" >/dev/null 2>&1 && echo "  âœ… ä»£ç è´¨é‡è‰¯å¥½" || echo "  âš ï¸  ä»£ç è´¨é‡é—®é¢˜"; \
					fi; \
				fi \
			done \
		fi \
	done

validate-config: ## éªŒè¯é…ç½®æ–‡ä»¶
	@echo "âš™ï¸  éªŒè¯é…ç½®æ–‡ä»¶"
	@if [ -f "config.yaml" ]; then \
		if command -v yq >/dev/null 2>&1; then \
			echo "ğŸ” YAML æ ¼å¼æ£€æŸ¥..."; \
			yq eval '.' config.yaml >/dev/null && echo "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®" || echo "âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"; \
		else \
			echo "âš ï¸  yq æœªå®‰è£…ï¼Œè·³è¿‡ YAML æ ¼å¼æ£€æŸ¥"; \
		fi; \
		echo "ğŸ“Š é…ç½®ç»Ÿè®¡:"; \
		echo "  å®‰è£…è„šæœ¬: $$(find install -name "*.sh" | wc -l)"; \
		echo "  å¸è½½è„šæœ¬: $$(find uninstall -name "*.sh" 2>/dev/null | wc -l)"; \
		echo "  é…ç½®è„šæœ¬: $$(find config -name "*.sh" 2>/dev/null | wc -l)"; \
	else \
		echo "âŒ é…ç½®æ–‡ä»¶ config.yaml ä¸å­˜åœ¨"; \
	fi

list-scripts: ## åˆ—å‡ºæ‰€æœ‰è„šæœ¬
	@echo "ğŸ“‹ è„šæœ¬åˆ—è¡¨"
	@echo ""
	@for dir in install uninstall config; do \
		if [ -d "$$dir" ]; then \
			echo "ğŸ“ $$dir/"; \
			for script in $$dir/*.sh; do \
				if [ -f "$$script" ]; then \
					name=$$(basename "$$script" .sh); \
					desc=$$(head -10 "$$script" | grep "# æè¿°:" | sed 's/# æè¿°: //g' || echo "æ— æè¿°"); \
					printf "  %-20s %s\n" "$$name" "$$desc"; \
				fi \
			done; \
			echo ""; \
		fi \
	done

stats: ## æ˜¾ç¤ºè„šæœ¬ç»Ÿè®¡ä¿¡æ¯
	@echo "ğŸ“Š è„šæœ¬ç»Ÿè®¡"
	@echo ""
	@total_scripts=0; \
	total_lines=0; \
	for dir in install uninstall config; do \
		if [ -d "$$dir" ]; then \
			count=$$(find $$dir -name "*.sh" | wc -l); \
			lines=$$(find $$dir -name "*.sh" -exec wc -l {} \; | awk '{sum += $$1} END {print sum}'); \
			echo "ğŸ“ $$dir: $$count ä¸ªè„šæœ¬, $$lines è¡Œä»£ç "; \
			total_scripts=$$((total_scripts + count)); \
			total_lines=$$((total_lines + lines)); \
		fi \
	done; \
	echo ""; \
	echo "ğŸ“ˆ æ€»è®¡: $$total_scripts ä¸ªè„šæœ¬, $$total_lines è¡Œä»£ç "

clean: ## æ¸…ç†ä¸´æ—¶æ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶"
	@find . -name "*.tmp" -delete
	@find . -name "*.log" -delete
	@find . -name ".DS_Store" -delete
	@find . -name "config-*.yaml" -delete
	@echo "âœ… æ¸…ç†å®Œæˆ"

install-tools: ## å®‰è£…å¼€å‘å·¥å…·
	@echo "ğŸ”§ å®‰è£…å¼€å‘å·¥å…·"
	@echo "æ£€æŸ¥ shellcheck..."
	@if ! command -v shellcheck >/dev/null 2>&1; then \
		echo "å®‰è£… shellcheck..."; \
		if command -v apt-get >/dev/null 2>&1; then \
			sudo apt-get update && sudo apt-get install -y shellcheck; \
		elif command -v yum >/dev/null 2>&1; then \
			sudo yum install -y epel-release && sudo yum install -y ShellCheck; \
		elif command -v brew >/dev/null 2>&1; then \
			brew install shellcheck; \
		else \
			echo "âš ï¸  è¯·æ‰‹åŠ¨å®‰è£… shellcheck"; \
		fi; \
	else \
		echo "âœ… shellcheck å·²å®‰è£…"; \
	fi
	@echo "æ£€æŸ¥ yq..."
	@if ! command -v yq >/dev/null 2>&1; then \
		echo "å®‰è£… yq..."; \
		sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64; \
		sudo chmod +x /usr/local/bin/yq; \
	else \
		echo "âœ… yq å·²å®‰è£…"; \
	fi
	@echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆ"

check-env: ## æ£€æŸ¥å¼€å‘ç¯å¢ƒ
	@echo "ğŸ” æ£€æŸ¥å¼€å‘ç¯å¢ƒ"
	@echo ""
	@echo "Go ç‰ˆæœ¬:"
	@go version 2>/dev/null || echo "âŒ Go æœªå®‰è£…"
	@echo ""

	@echo ""
	@echo "Shellcheck:"
	@shellcheck --version 2>/dev/null || echo "âŒ Shellcheck æœªå®‰è£…"
	@echo ""
	@echo "yq:"
	@yq --version 2>/dev/null || echo "âŒ yq æœªå®‰è£…"

# å¿«æ·å‘½ä»¤åˆ«å
new: generate ## ç”Ÿæˆæ–°è„šæœ¬çš„åˆ«å
check: lint ## æ£€æŸ¥è„šæœ¬çš„åˆ«å
run-test: test ## è¿è¡Œæµ‹è¯•çš„åˆ«å
